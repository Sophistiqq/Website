<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products</title>
    <!-- use css from public folder -->
    <link rel="stylesheet" href="./css/products-page.css">
    <link rel="stylesheet" href="./css/products-page-phone.css">
    <script src="./scripts/products.js" defer></script>
</head>

<body>
    <header>
        <nav class="nav">
            <!-- Logo -->
            <div class="logo">
                <img src="./images/bread 1.png" alt="logo">
                <div class="brand">
                    <p>BreadBites</p>
                    <p>Affordable Bakery</p>
                </div>
            </div>
            <div class="links">
                <a href="/">Home</a>
                <a href="/#about">About</a>
            </div>
            <% if (loggedIn) { %>
                <% if (role === "admin") { %>
                    <div class="button-wrapper">
                        <button class="adminBtn cartBtn mobile-only">Open Cart</button>
                        <a href="/admin" class="adminBtn">Admin Panel</a>
                        <a href="/logout" class="logout" title="Log out"><img src="/images/logout.png" alt=""></a>
                    </div>
                <% } else { %>
                    <div class="button-wrapper">
                        <a href="/profile" class="profileBtn">Profile</a>
                        <a href="/logout" class="logout" title="Log out"><img src="/images/logout.png" alt=""></a>
                    </div>
                <% } %>
                <% } else { %>
                    <div class="button-wrapper">
                        <button class="signinBtn" id="signInBtn">Sign In</button>
                    </div>
                <% } %>
        </nav>

    </header>



    <!-- For signins -->
    <div class="popup">
        <div class="forms">
            <form action="/login" method="post" class="signin">
                <h1>Sign In</h1>
                <div class="inputfield">
                    <label for="">Username</label>
                    <input type="text" class="username" name="username" required>
                </div>
                <div class="inputfield">
                    <label for="">Password</label>
                    <input type="password" class="password" name="password" required>
                </div>
                <button type="submit">Sign In</button>
            </form>

            <form action="/register" method="post" class="register hide">
                <h1>Register</h1>
                <div class="inputfield">
                    <label for="">Name</label>
                    <input type="text" name="name" required>
                </div>
                <div class="inputfield">
                    <label for="">Username</label>
                    <input type="text" name="username" required>
                </div>
                <div class="inputfield">
                    <label for="">Email</label>
                    <input type="text" name="email" required>
                </div>
                <div class="inputfield">
                    <label for="">Password</label>
                    <input type="password" name="password" required>
                </div>
                <div class="inputfield">
                    <label for="">Contact Number</label>
                    <input type="text" name="contact_number" required>
                </div>
                <div class="inputfield">
                    <label for="">Address</label>
                    <input type="text" name="address" required>
                </div>
                <button type="submit">Submit</button>
            </form>
            <button id="closeBtn">Close</button>
            <button id="signinOrRegister">Register</button>
        </div>
    </div>

    <div class="products-body">
        <nav class="categories">
            <h1>Categories</h1>
            <div class="categories-link">
                <a href="#mini-donuts">Mini-Donuts</a>
                <a href="#sliced-cake">Sliced Cake</a>
                <a href="#cupcakes">Cupcakes</a>
            </div>
        </nav>

        <div class="products">
            <section class="sections" id="mini-donuts">
                <% products.filter(product => product.category === 'md').forEach((product, index) => { %>
                    <div class="product">
                        <img src="<%= product.image_loc %>" alt="Product Image">
                        <div class="product-info">
                            <h1><%= product.product_name %></h1>
                            <p><%= product.product_description %></p>
                            <p>Price: <%= product.price %></p>
                            <button class="add-to-cart" data-product-id="<%= product.id %>">Add to Cart</button>
                            <div class="navigation-buttons">
                                <% if (index > 0) { %>
                                    <button class="previous-product">Previous</button>
                                <% } %>
                                <% if (index < products.filter(product => product.category === 'md').length - 1) { %>
                                    <button class="next-product">Next</button>
                                <% } %>
                            </div>
                        </div>
                    </div>
                <% }); %>
            </section>

            <section class="sections" id="sliced-cake">
                <% products.filter(product => product.category === 'sc').forEach((product, index) => { %>
                    <div class="product">
                        <img src="<%= product.image_loc %>" alt="Product Image">
                        <div class="product-info">
                            <h1><%= product.product_name %></h1>
                            <p><%= product.product_description %></p>
                            <p>Price: <%= product.price %></p>
                            <button class="add-to-cart" data-product-id="<%= product.id %>">Add to Cart</button>
                            <div class="navigation-buttons">
                                <% if (index > 0) { %>
                                    <button class="previous-product">Previous</button>
                                <% } %>
                                <% if (index < products.filter(product => product.category === 'sc').length - 1) { %>
                                    <button class="next-product">Next</button>
                                <% } %>
                            </div>
                        </div>
                    </div>
                <% }); %>
            </section>

            <section class="sections" id="cupcakes">
                <% products.filter(product => product.category === 'cc').forEach((product, index) => { %>
                    <div class="product">
                        <img src="<%= product.image_loc %>" alt="Product Image">
                        <div class="product-info">
                            <h1><%= product.product_name %></h1>
                            <p><%= product.product_description %></p>
                            <p>Price: <%= product.price %></p>
                            <button class="add-to-cart" data-product-id="<%= product.id %>">Add to Cart</button>
                            <div class="navigation-buttons">
                                <% if (index > 0) { %>
                                    <button class="previous-product">Previous</button>
                                <% } %>
                                <% if (index < products.filter(product => product.category === 'cc').length - 1) { %>
                                    <button class="next-product">Next</button>
                                <% } %>
                            </div>
                        </div>
                    </div>
                <% }); %>
            </section>

            <section class="mobile-view" id="all-products">
                <% products.forEach((product, index) => { %>
                    <div class="product">
                        <img src="<%= product.image_loc %>" alt="Product Image">
                        <div class="product-info">
                            <h1><%= product.product_name %></h1>
                            <p><%= product.product_description %></p>
                            <p>Price: <%= product.price %></p>
                            <button class="add-to-cart" data-product-id="<%= product.id %>">Add to Cart</button>
                        </div>
                    </div>
                <% }); %>
            </section>
        </div>  
        <div class="cart-modal">
            <div class="cart">
                <% if (!loggedIn) { %>
                    <div class="cart-content-not-logged-in">
                        <p>Please login first to use the Cart</p>
                        <button class="signinBtn" id="signInBtn">Sign In</button>
                    </div>
                <% } else { %>
                    <p>Welcome, <%= username %>!</p>
                    <h3 class="total-cost">Total Cost: â‚±<span id="totalCostAmount">0.00</span></h3>
                    <div class="cart-content">
                        <ul></ul>
                        <button class="checkoutBtn">Checkout</button>
                    </div>
                    <button class="close-modal" id="closeModalBtn">Close</button>
                <% } %>
            </div>
        </div>

    </div>

</body>
<script>
    let addToCartButtons = document.querySelectorAll('.add-to-cart');
    let cart = document.querySelector('.cart-content ul');
    let totalCost = 0;

    function updateTotalCost() {
        totalCost = 0;
        Array.from(cart.children).forEach(item => {
            let itemPrice = item.querySelector('.item-price').innerText;
            let itemPriceValue = parseFloat(itemPrice.replace(/[^0-9.-]+/g,""));
            let quantity = parseInt(item.querySelector('.quantity').value);
            totalCost += itemPriceValue * quantity;
        });

        let totalCostElement = document.querySelector('#totalCostAmount');
        totalCostElement.innerText = totalCost.toFixed(2);
    }

    addToCartButtons.forEach(button => {
        button.addEventListener('click', function () {
            let productInfo = this.parentElement;
            let productName = productInfo.querySelector('h1').innerText;
            let productPrice = productInfo.children[2].innerText;
            let productPriceValue = parseFloat(productPrice.replace(/[^0-9.-]+/g,""));

            let existingCartItem = Array.from(cart.children).find(item => {
                let itemName = item.querySelector('.item-name').innerText;
                return itemName === productName;
            });

            if (existingCartItem) {
                let quantityElement = existingCartItem.querySelector('.quantity');
                let quantity = parseInt(quantityElement.value);
                quantityElement.value = quantity + 1;
            } else {
                let cartItem = document.createElement('li');
                cartItem.className = "cart-item";
                cartItem.innerHTML = `
                                    <div class="item-info">
                                        <h5 class="item-name">${productName}</h5>
                                        <p class="item-price">${productPrice}</p>
                                    </div>
                                    <div class="item-quantity">
                                        <input type="number" class="quantity" value="1" readonly>
                                        <button class="add-quantity">+</button>
                                        <button class="remove-quantity">-</button>
                                    </div>
                                    <button class="remove-item">Remove</button>
                                `;
                cart.appendChild(cartItem);
            }

            updateTotalCost();
        });
    });

    cart.addEventListener('click', function (event) {
        if (event.target.classList.contains('add-quantity')) {
            let quantityElement = event.target.previousElementSibling;
            let quantity = parseInt(quantityElement.value);
            quantityElement.value = quantity + 1;
        } else if (event.target.classList.contains('remove-quantity')) {
            let quantityElement = event.target.parentElement.querySelector('.quantity');
            let quantity = parseInt(quantityElement.value);
            if (quantity > 1) {
                quantityElement.value = quantity - 1;
            }
        } else if (event.target.classList.contains('remove-item')) {
            let cartItem = event.target.closest('.cart-item');
            cartItem.remove();
        }

        updateTotalCost();
    });
</script>

</html>